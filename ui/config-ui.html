<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Context Server - Configuration Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      /* Blue */
      --secondary-accent: #8b5cf6;
      /* Purple */
      --tertiary-accent: #ec4899;
      /* Pink */
      --quaternary-accent: #f472b6;
      /* Lighter Pink/Coral */
      --primary-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info-bg: #3b82f6;
      --bg-primary: #0f172a;
      /* Dark Slate */
      --bg-secondary: #1e293b;
      /* Lighter Slate */
      --bg-tertiary: #334155;
      /* Even Lighter Slate */
      --text-primary: #f1f5f9;
      /* Almost White */
      --text-secondary: #cbd5e1;
      /* Light Gray */
      --text-muted: #94a3b8;
      /* Gray */
      --border: #475569;
      /* Slate Border */
      --radius: 8px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2rem;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .header h1 {
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 0.75rem;

      /* Animated Gradient Text */
      background: linear-gradient(120deg,
          var(--primary) 0%,
          var(--secondary-accent) 25%,
          var(--tertiary-accent) 50%,
          var(--quaternary-accent) 75%,
          var(--primary) 100%);
      background-size: 400% 100%;
      /* Make background wider for smooth animation */

      -webkit-background-clip: text;
      -moz-background-clip: text;
      background-clip: text;

      -webkit-text-fill-color: transparent;
      -moz-text-fill-color: transparent;
      color: transparent;
      /* General fallback for transparency */

      animation: animateGradientText 12s linear infinite;
      /* Animation properties */

      text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
      /* Subtle shadow for definition */
    }

    @keyframes animateGradientText {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 400% 50%;
        /* Match background-size for a full cycle */
      }
    }


    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .tabs {
      display: flex;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 0.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .tab {
      flex: 1;
      padding: 1rem 1.5rem;
      text-align: center;
      cursor: pointer;
      border-radius: calc(var(--radius) - 2px);
      transition: all 0.2s;
      font-weight: 500;
      color: var(--text-muted);
    }

    .tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }

    .tab:hover:not(.active) {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .main-section {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-icon {
      width: 1.75rem;
      height: 1.75rem;
      background: var(--primary);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: white;
    }

    .main-section>div:not(:first-of-type),
    .main-section>h3:not(:first-of-type),
    .main-section>.btn-group:not(:first-of-type),
    .main-section>.grid-3:not(:first-of-type),
    /* Ensure grids also get dividers if not first*/
    .main-section>.grid-2:not(:first-of-type),
    .main-section>.server-config:not(:first-of-type),
    .main-section>.form-group.config-preview-container:not(:first-of-type) {
      /* For config preview if needed */
      border-top: 1px solid var(--border);
      padding-top: 2rem;
      margin-top: 2rem;
    }

    .main-section>h2.section-title+* {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .main-section>h2.section-title+h3 {
      margin-top: 1.5rem;
      padding-top: 0;
      border-top: none;
    }

    /* Further ensure specific major blocks get dividers */
    .main-section .config-status+.form-group,
    /* After status cards before first real form group */
    .main-section .server-config+.form-group,
    /* After server-config grid before config preview */
    .main-section .grid-3+.btn-group,
    /* After the main security grid before save buttons */
    .main-section .grid-2+h3,
    /* After general server config grid before logging/perf title */
    .main-section h3+.grid-2

    /* After Logging & Perf title before its grid */
      {
      border-top: 1px solid var(--border);
      padding-top: 2rem;
      margin-top: 2rem;
    }


    .config-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .status-card {
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .status-card h3 {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .status-card .value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-control:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
      font-family: 'Courier New', monospace;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 8px -2px rgba(0, 0, 0, 0.12), 0 3px 5px -2px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #0f9a6c;
      transform: translateY(-1px);
    }


    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      background: #e08f0a;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #d73737;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--border);
      color: var(--text-primary);
      transform: translateY(-1px);
    }


    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .config-preview {
      background: #0d1117;
      color: #a5d6ff;
      padding: 1rem;
      border-radius: var(--radius);
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 1rem;
      border: 1px solid var(--border);
    }

    .item-list-container {
      margin-top: 1rem;
    }

    .item-tag,
    .command-tag {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid var(--border);
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .item-tag .remove,
    .command-tag .remove {
      cursor: pointer;
      color: var(--danger);
      font-weight: bold;
      padding: 0 0.25rem;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.1);
    }

    .item-tag .remove:hover,
    .command-tag .remove:hover {
      background: var(--danger);
      color: white;
    }


    .safezone-list {
      margin-top: 1rem;
    }

    .safezone-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
    }

    .safezone-path {
      font-family: monospace;
      color: var(--text-primary);
    }

    .alert {
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      border-left: 4px solid;
    }


    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .path-display {
      background: var(--bg-tertiary);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      word-break: break-all;
    }

    .server-config {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .presets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .preset-btn {
      padding: 0.75rem;
      text-align: center;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid var(--border);
      background: var(--bg-tertiary);
    }

    .preset-btn:hover:not(:disabled) {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
    }

    .preset-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .preset-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: var(--border);
      background: var(--bg-tertiary);
    }


    .preset-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .preset-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    @media (max-width: 992px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }


    @media (max-width: 768px) {

      .server-config,
      .grid-2 {
        grid-template-columns: 1fr;
      }

      .config-status {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        margin-bottom: 0.25rem;
      }
    }

    .instructions {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-top: 2rem;
    }

    .instructions h3 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .instructions ol {
      padding-left: 1.5rem;
    }

    .instructions li {
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 350px;
      max-width: 90%;
    }

    .toast {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      border-left: 5px solid;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast-message {
      flex-grow: 1;
      white-space: pre-wrap;
    }

    .toast-close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.25rem;
      margin-left: 1rem;
    }

    .toast-close-btn:hover {
      color: var(--text-primary);
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    .toast.danger {
      border-left-color: var(--danger);
    }

    .toast.info {
      border-left-color: var(--info-bg);
    }
  </style>
</head>

<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <div class="header">
      <h1>MCP Context Server</h1>
      <p>Complete Configuration Management for Claude Desktop Integration & Server Security</p>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab(event, 'claude-desktop')">🔗 Claude Desktop</div>
      <div class="tab" onclick="switchTab(event, 'security')">🔒 Security Settings</div>
      <div class="tab" onclick="switchTab(event, 'server')">⚙️ Server Configuration</div>
    </div>

    <!-- Claude Desktop Configuration Tab -->
    <div class="tab-content active" id="claude-desktop-tab">
      <div class="main-section">
        <h2 class="section-title">
          <span class="section-icon">🔗</span>
          Claude Desktop Integration
        </h2>
        <div class="config-status">
          <div class="status-card">
            <h3>Config File Status</h3>
            <div class="value" id="claudeConfigStatus">Checking...</div>
          </div>
          <div class="status-card">
            <h3>Platform</h3>
            <div class="value" id="platformInfo">-</div>
          </div>
          <div class="status-card">
            <h3>MCP Server Status</h3>
            <div class="value" id="claudeServerStatus">Not Configured</div>
          </div>
        </div>
        <div class="form-group">
          <label for="claudeConfigPath">Claude Desktop Config File Location</label>
          <div class="path-display" id="claudeConfigPath">Detecting...</div>
          <div class="help-text">This is where your Claude Desktop configuration is stored.</div>
        </div>
        <div class="server-config">
          <div>
            <div class="form-group">
              <label for="serverName">Server Name in Claude Desktop</label>
              <input type="text" id="serverName" class="form-control" value="context-savvy-mcp"
                placeholder="context-savvy-mcp">
              <div class="help-text">Unique name for this MCP server as it will appear in Claude Desktop.</div>
            </div>
            <div class="form-group">
              <label for="serverPath">Server Executable Path</label>
              <input type="text" id="serverPath" class="form-control" placeholder="/absolute/path/to/dist/index.js">
              <div class="help-text">Absolute path to your built server (e.g., `dist/index.js`). Click "Auto-Detect" if
                unsure.</div>
            </div>
            <div class="form-group">
              <label for="logLevel">Server Log Level (for this MCP Server)</label>
              <select id="logLevel" class="form-control">
                <option value="trace">Trace</option>
                <option value="debug">Debug</option>
                <option value="info" selected>Info</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
                <option value="fatal">Fatal</option>
              </select>
              <div class="help-text">Log level for this MCP server when launched by Claude Desktop.</div>
            </div>
          </div>
          <div>
            <div class="form-group">
              <label>Quick Actions</label>
              <div class="btn-group">
                <button class="btn btn-primary" onclick="autoDetectPath()">🔍 Auto-Detect Path</button>
                <button class="btn btn-secondary" onclick="loadClaudeConfig()">🔄 Load Current</button>
              </div>
            </div>
            <div class="form-group">
              <label>Configuration Actions</label>
              <div class="btn-group">
                <button class="btn btn-success" onclick="saveClaudeDesktopEntry()">💾 Save to Claude Config</button>
                <button class="btn btn-warning" onclick="removeClaudeDesktopEntry()">🗑️ Remove from Claude
                  Config</button>
              </div>
              <div class="help-text">These actions directly modify your `claude_desktop_config.json` file.</div>
            </div>
          </div>
        </div>
        <div class="form-group config-preview-container">
          <label for="claudeConfigPreview">Current `claude_desktop_config.json` Preview</label>
          <div class="config-preview" id="claudeConfigPreview">Loading configuration...</div>
          <div class="help-text">This shows the current content of your Claude Desktop configuration file.</div>
        </div>
      </div>
    </div>

    <!-- Security Settings Tab -->
    <div class="tab-content" id="security-tab">
      <div class="main-section">
        <h2 class="section-title">
          <span class="section-icon">🔒</span>
          Security Configuration (`config/server.yaml`)
        </h2>
        <div class="config-status">
          <div class="status-card">
            <h3>Server Config Status</h3>
            <div class="value" id="serverConfigStatus">Checking...</div>
          </div>
          <div class="status-card">
            <h3>Allowed Commands</h3>
            <div class="value" id="commandCount">-</div>
          </div>
          <div class="status-card">
            <h3>Safe Zones</h3>
            <div class="value" id="safezoneCount">-</div>
          </div>
          <div class="status-card">
            <h3>Unsafe Arg Patterns</h3>
            <div class="value" id="unsafePatternCount">-</div>
          </div>
        </div>

        <div class="grid-3">
          <div>
            <h4>Allowed Commands</h4>
            <div class="form-group">
              <label>Security Presets</label>
              <div class="help-text">Choose a security level for allowed commands</div>
              <div class="presets-grid" id="commandPresetsContainer">
                <div class="preset-btn" onclick="setSecurityPreset(event, 'minimal')">
                  <div class="preset-title">🛡️ Minimal OS</div>
                  <div class="preset-desc">Basic OS commands</div>
                </div>
                <div class="preset-btn" onclick="setSecurityPreset(event, 'standard')">
                  <div class="preset-title">⚖️ Standard OS + Tools</div>
                  <div class="preset-desc">Common OS & All Tools</div>
                </div>
                <div class="preset-btn" onclick="setSecurityPreset(event, 'developer')">
                  <div class="preset-title">🔧 Developer OS + Tools</div>
                  <div class="preset-desc">Extended OS & All Tools</div>
                </div>
                <div class="preset-btn" onclick="setSecurityPreset(event, 'custom')">
                  <div class="preset-title">⚙️ Custom</div>
                  <div class="preset-desc">Configure manually</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="allowedCommands">Allowed Commands (one per line)</label>
              <textarea id="allowedCommands" class="form-control" rows="5" placeholder="ls
cat
read_file
execute_command"></textarea>
            </div>
            <div class="form-group">
              <label for="addCommandInput">Add Command</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="addCommandInput" class="form-control" placeholder="e.g., python3 or a_tool_name">
                <button id="addCommandBtn" class="btn btn-primary" onclick="addCommand()">Add</button>
              </div>
            </div>
            <div class="item-list-container" id="commandList"></div>
          </div>

          <div>
            <h4>Safe Zones</h4>
            <div class="form-group">
              <label for="safezones">Safe Zones (one per line)</label>
              <div class="help-text">Directories where file operations are allowed</div>
              <textarea id="safezones" class="form-control" rows="6" placeholder=".
/tmp
/home/user/projects"></textarea>
            </div>
            <div class="form-group">
              <label for="addSafezoneInput">Add Safe Zone</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="addSafezoneInput" class="form-control" placeholder="/path/to/directory">
                <button id="addSafezoneBtn" class="btn btn-primary" onclick="addSafezone()">Add</button>
              </div>
            </div>
            <div class="safezone-list" id="safezoneList"></div>
          </div>

          <div>
            <h4>Unsafe Argument Patterns</h4>
            <div class="form-group">
              <label>Pattern Presets</label>
              <div class="help-text">Choose a strictness level for unsafe argument patterns</div>
              <div class="presets-grid" id="unsafePatternPresetsContainer">
                <div class="preset-btn" onclick="setUnsafePatternPreset(event, 'strict')">
                  <div class="preset-title">🚨 Strict</div>
                  <div class="preset-desc">Blocks many patterns</div>
                </div>
                <div class="preset-btn" onclick="setUnsafePatternPreset(event, 'balanced')">
                  <div class="preset-title">⚖️ Balanced</div>
                  <div class="preset-desc">Commonly blocked patterns</div>
                </div>
                <div class="preset-btn" onclick="setUnsafePatternPreset(event, 'custom')">
                  <div class="preset-title">⚙️ Custom</div>
                  <div class="preset-desc">Configure manually</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="unsafeArgumentPatterns">Unsafe Argument Patterns (Regex, one per line)</label>
              <textarea id="unsafeArgumentPatterns" class="form-control" rows="5"
                placeholder="\\$\\(|`|\\$\\{.*\\}"></textarea>
            </div>
            <div class="form-group">
              <label for="addUnsafePatternInput">Add Unsafe Pattern (Regex)</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="addUnsafePatternInput" class="form-control" placeholder="e.g., ;\\s*rm">
                <button id="addUnsafePatternBtn" class="btn btn-primary" onclick="addUnsafePattern()">Add</button>
              </div>
            </div>
            <div class="item-list-container" id="unsafePatternList"></div>
          </div>
        </div>

        <div class="btn-group">
          <button id="saveSecurityBtn" class="btn btn-success" onclick="saveSecurityConfig()">💾 Save Security
            Settings</button>
          <button class="btn btn-secondary" onclick="loadServerConfig()">🔄 Reload Settings</button>
          <button class="btn btn-warning" onclick="resetSecurityToDefaults()">↩️ Reset Security to Defaults</button>
        </div>
      </div>
    </div>

    <!-- Server Configuration Tab -->
    <div class="tab-content" id="server-tab">
      <div class="main-section">
        <h2 class="section-title">
          <span class="section-icon">⚙️</span>
          Server Configuration (General)
        </h2>
        <div class="grid-2">
          <div>
            <div class="form-group">
              <label for="serverName2">Server Name (in `server.yaml`)</label>
              <input type="text" id="serverName2" class="form-control" value="context-savvy-mcp">
            </div>
            <div class="form-group">
              <label for="maxExecutionTime">Max Execution Time (ms)</label>
              <input type="number" id="maxExecutionTime" class="form-control" value="30000">
              <div class="help-text">Maximum time for command execution</div>
            </div>
            <div class="form-group">
              <label for="maxFileSize">Max File Size (bytes)</label>
              <input type="number" id="maxFileSize" class="form-control" value="10485760">
              <div class="help-text">Maximum file size for operations (10MB default)</div>
            </div>
          </div>
          <div>
            <div class="form-group">
              <label for="databasePath">Database Path</label>
              <input type="text" id="databasePath" class="form-control" value="./data/context.db">
              <div class="help-text">Path to SQLite database file (relative to server CWD or absolute)</div>
            </div>
            <div class="form-group">
              <label for="backupInterval">Backup Interval (minutes)</label>
              <input type="number" id="backupInterval" class="form-control" value="60">
              <div class="help-text">0 to disable automatic backups</div>
            </div>
          </div>
        </div>
        <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--text-secondary);">Logging & Performance</h3>
        <div class="grid-2">
          <div>
            <div class="form-group">
              <label for="serverLogLevel">Server Log Level (for `server.yaml`)</label>
              <select id="serverLogLevel" class="form-control">
                <option value="trace">Trace</option>
                <option value="debug">Debug</option>
                <option value="info" selected>Info</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
                <option value="fatal">Fatal</option>
              </select>
            </div>
            <div class="form-group">
              <label for="prettyLogging">Pretty Logging</label>
              <select id="prettyLogging" class="form-control">
                <option value="true" selected>Enabled</option>
                <option value="false">Disabled</option>
              </select>
            </div>
          </div>
          <div>
            <div class="form-group">
              <label for="maxConcurrency">Max Concurrency</label>
              <input type="number" id="maxConcurrency" class="form-control" value="10">
              <div class="help-text">Maximum concurrent operations</div>
            </div>
            <div class="form-group">
              <label for="queueSize">Queue Size</label>
              <input type="number" id="queueSize" class="form-control" value="1000" disabled>
              <div class="help-text">Max operations in queue (not currently user-editable)</div>
            </div>
          </div>
        </div>

        <div class="btn-group">
          <button id="saveServerBtn" class="btn btn-success" onclick="saveCompleteServerConfig()">💾 Save
            `server.yaml`</button>
          <button class="btn btn-secondary" onclick="loadServerConfig()">🔄 Reload `server.yaml`</button>
          <button class="btn btn-primary" onclick="testServerConfig()">🧪 Test Configuration</button>
        </div>

        <div class="form-group config-preview-container">
          <label for="serverConfigPreview">Current `server.yaml` Preview</label>
          <div class="config-preview" id="serverConfigPreview">Loading server configuration...</div>
        </div>
      </div>
    </div>

    <div class="instructions">
      <h3>🚀 Complete Setup Guide</h3>
      <ol>
        <li><strong>Configure Security (Server-Side):</strong> Use the "Security Settings" tab to adjust
          `allowedCommands`, `safezones`, etc. in your `config/server.yaml`. Save these changes.</li>
        <li><strong>Adjust General Server Settings:</strong> Use the "Server Configuration" tab for timeouts, database
          path, logging in `config/server.yaml`. Save these changes.</li>
        <li><strong>Setup Claude Desktop Integration:</strong> Use the "Claude Desktop" tab. Ensure "Server Executable
          Path" is correct (use Auto-Detect). Click "Save to Claude Config". This directly modifies your
          `claude_desktop_config.json`.</li>
        <li><strong>Restart Claude Desktop:</strong> Close and reopen Claude Desktop completely for changes to take
          effect.</li>
        <li><strong>Test Integration:</strong> Ask Claude to list files or execute commands.</li>
      </ol>
      <div class="alert alert-info" style="margin-top: 1rem;">
        <strong>💡 Pro Tip:</strong> The `MCP_SERVER_CONFIG_PATH` environment variable in `claude_desktop_config.json`
        tells this server which `config/server.yaml` (or equivalent) to use. The UI helps set this up with a default
        path.
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentClaudeConfig = {};
    let currentServerConfig = {}; // For server.yaml
    let platformInfo = {}; // Will hold claudeConfigPath, projectRoot etc.

    const allToolNames = [
      'read_file', 'write_file', 'list_directory', 'execute_command',
      'store_context', 'get_context', 'query_context',
      'create_smart_path', 'execute_smart_path', 'list_smart_paths',
      'create_workspace', 'list_workspaces', 'switch_workspace', 'sync_workspace',
      'track_file', 'get_workspace_stats', 'delete_workspace', 'export_workspace_template',
      'parse_file', 'get_metrics', 'security_diagnostics', 'database_health'
    ];

    const commonOsCommands = ['ls', 'cat', 'grep', 'find', 'echo', 'pwd', 'whoami', 'dir', 'type', 'where'];
    const developerOsCommands = [...commonOsCommands, 'git', 'npm', 'node', 'python', 'python3'];


    const commandSecurityPresets = {
      minimal: { commands: [...commonOsCommands], description: 'Basic OS commands only' },
      standard: { commands: [...new Set([...commonOsCommands, ...allToolNames])], description: 'Common OS commands & All Tools' },
      developer: { commands: [...new Set([...developerOsCommands, ...allToolNames])], description: 'Extended OS commands & All Tools' },
      custom: { commands: [], description: 'Configure manually' }
    };

    const unsafePatternPresets = {
      strict: {
        patterns: [
          "\\$\\(|`|\\$\\{.*\\}",
          "(?:^|\\s)(?:-|--)(?:exec|execute|command|eval|source|run|call|start|invoke|delegate)(?:$|\\s|=)",
          ";",
          "\\|\\|",
          "&&",
          "\\|(?![|=])"
        ],
        description: 'Blocks many patterns including common injection vectors'
      },
      balanced: {
        patterns: [
          "\\$\\(|`|\\$\\{.*\\}",
          "(?:^|\\s)(?:-|--)(?:exec|execute|command|eval|source)(?:$|\\s|=)",
        ],
        description: 'Blocks common command injection patterns'
      },
      custom: { patterns: [], description: 'Configure manually' }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      await detectPlatform(); // This sets platformInfo globally
      await loadClaudeConfig();
      await loadServerConfig();
      await autoDetectPath();
      setupInputListeners();
    });

    function setupInputListeners() {
      ['addCommandInput', 'addSafezoneInput', 'addUnsafePatternInput'].forEach(id => {
        const inputEl = document.getElementById(id);
        const btnEl = document.getElementById(id.replace('Input', 'Btn'));
        if (inputEl && btnEl) {
          inputEl.addEventListener('input', (e) => {
            btnEl.disabled = e.target.value.trim() === '';
          });
          btnEl.disabled = true;
        }
      });
    }


    function switchTab(event, tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.currentTarget.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    async function detectPlatform() {
      try {
        const response = await fetch('/api/platform-info');
        platformInfo = await response.json(); // platformInfo is now global
        document.getElementById('platformInfo').textContent = platformInfo.platformName;
        document.getElementById('claudeConfigPath').textContent = platformInfo.claudeConfigPath; // Updated field for claudeConfigPath
      } catch (error) {
        showAlert('Failed to detect platform: ' + error.message, 'danger');
      }
    }

    async function loadClaudeConfig() {
      try {
        showLoading('claudeConfigStatus');
        const response = await fetch('/api/claude-config');
        const result = await response.json();
        if (result.config) { // Check if config object is present
          currentClaudeConfig = result.config;
          document.getElementById('claudeConfigStatus').textContent = result.exists ? '✅ Found' : '📄 Not Found (Using Defaults)';
          updateClaudeConfigPreview();
          updateClaudeDesktopFormFields();
          updateClaudeServerStatus();
        } else {
          document.getElementById('claudeConfigStatus').textContent = '❌ Error Loading';
          showAlert('Error loading Claude Desktop configuration: ' + (result.error || 'No config data returned'), 'danger');
          currentClaudeConfig = { mcpServers: {} }; // Ensure it's an object
          updateClaudeConfigPreview(); // Show empty or default
        }
      } catch (error) {
        document.getElementById('claudeConfigStatus').textContent = '❌ Error';
        showAlert('Failed to load Claude Desktop configuration: ' + error.message, 'danger');
        currentClaudeConfig = { mcpServers: {} };
        updateClaudeConfigPreview();
      }
    }

    function updateClaudeDesktopFormFields() {
      const servers = currentClaudeConfig.mcpServers || {};      // Try to find a server entry that looks like ours, or default to 'context-savvy-mcp'
      const serverKeys = Object.keys(servers);
      let ourServerName = 'context-savvy-mcp'; // Default
      let ourServerEntry = servers[ourServerName];

      if (!ourServerEntry) {
        // Attempt to find by looking at args, if only one server is configured or common path element exists
        const potentialServerKey = serverKeys.find(key =>
          servers[key]?.args?.some(arg => arg.includes('context-savvy-mcp') || arg.includes('dist/index.js'))
        );
        if (potentialServerKey) {
          ourServerName = potentialServerKey;
          ourServerEntry = servers[ourServerName];
        }
      }

      document.getElementById('serverName').value = ourServerName;
      document.getElementById('serverPath').value = ourServerEntry?.args?.[ourServerEntry.args.length - 1] || '';
      document.getElementById('logLevel').value = ourServerEntry?.env?.MCP_LOG_LEVEL || 'info';
    }


    async function loadServerConfig() {
      try {
        showLoading('serverConfigStatus');
        const response = await fetch('/api/server-config');
        const result = await response.json();

        if (result.config) {
          currentServerConfig = result.config;

          const securityConf = currentServerConfig.security || {};
          document.getElementById('allowedCommands').value = Array.isArray(securityConf.allowedCommands) ? securityConf.allowedCommands.join('\n') : (securityConf.allowedCommands === 'all' ? 'all' : '');
          document.getElementById('safezones').value = (securityConf.safezones || []).join('\n');
          document.getElementById('unsafeArgumentPatterns').value = (securityConf.unsafeArgumentPatterns || []).join('\n');

          updateCommandList();
          updateSafezoneList();
          updateUnsafePatternList();
          updateActiveSecurityPresets();

          document.getElementById('serverName2').value = currentServerConfig.server?.name || 'context-savvy-mcp';
          document.getElementById('maxExecutionTime').value = securityConf.maxExecutionTime || 30000;
          document.getElementById('maxFileSize').value = securityConf.maxFileSize || 10485760;
          document.getElementById('databasePath').value = currentServerConfig.database?.path || './data/context.db';
          document.getElementById('backupInterval').value = currentServerConfig.database?.backupInterval || 60;
          document.getElementById('serverLogLevel').value = currentServerConfig.logging?.level || 'info';
          document.getElementById('prettyLogging').value = String(currentServerConfig.logging?.pretty !== false); // Default to true if undefined
          document.getElementById('maxConcurrency').value = currentServerConfig.performance?.maxConcurrency || 10;
          document.getElementById('queueSize').value = currentServerConfig.performance?.queueSize || 1000;

          document.getElementById('serverConfigStatus').textContent = result.exists ? '✅ Found' : '📄 Defaults';
          updateServerConfigPreview();

        } else {
          document.getElementById('serverConfigStatus').textContent = '❌ Error';
          showAlert('Failed to load server configuration: ' + (result.error || 'Unknown error'), 'danger');
        }
      } catch (error) {
        document.getElementById('serverConfigStatus').textContent = '❌ Error';
        showAlert('Failed to load server configuration: ' + error.message, 'danger');
      }
    }

    function arraysEqual(a, b) {
      if (a === b) return true;
      if (a == null || b == null) return false;
      if (a.length !== b.length) return false;
      const sortedA = [...a].sort();
      const sortedB = [...b].sort();
      for (let i = 0; i < sortedA.length; ++i) {
        if (sortedA[i] !== sortedB[i]) return false;
      }
      return true;
    }

    function updateActiveSecurityPresets() {
      const currentCommands = document.getElementById('allowedCommands').value.split('\n').map(c => c.trim()).filter(c => c);
      document.querySelectorAll('#commandPresetsContainer .preset-btn').forEach(btn => {
        const presetNameMatch = btn.onclick.toString().match(/setSecurityPreset\(\s*event\s*,\s*['"](.*?)['"]\)/);
        if (!presetNameMatch) return;
        const presetName = presetNameMatch[1];

        if (presetName === 'custom') {
          const isCustomActive = !Object.keys(commandSecurityPresets).some(key =>
            key !== 'custom' && arraysEqual(commandSecurityPresets[key].commands, currentCommands)
          );
          btn.classList.toggle('active', isCustomActive);
          btn.disabled = isCustomActive;
        } else if (commandSecurityPresets[presetName]) {
          const isActive = arraysEqual(commandSecurityPresets[presetName].commands, currentCommands);
          btn.classList.toggle('active', isActive);
          btn.disabled = isActive;
        }
      });

      const currentUnsafePatterns = document.getElementById('unsafeArgumentPatterns').value.split('\n').map(p => p.trim()).filter(p => p);
      document.querySelectorAll('#unsafePatternPresetsContainer .preset-btn').forEach(btn => {
        const presetNameMatch = btn.onclick.toString().match(/setUnsafePatternPreset\(\s*event\s*,\s*['"](.*?)['"]\)/);
        if (!presetNameMatch) return;
        const presetName = presetNameMatch[1];

        if (presetName === 'custom') {
          const isCustomActive = !Object.keys(unsafePatternPresets).some(key =>
            key !== 'custom' && unsafePatternPresets[key] && arraysEqual(unsafePatternPresets[key].patterns, currentUnsafePatterns)
          );
          btn.classList.toggle('active', isCustomActive);
          btn.disabled = isCustomActive;
        } else if (unsafePatternPresets[presetName]) {
          const isActive = arraysEqual(unsafePatternPresets[presetName].patterns, currentUnsafePatterns);
          btn.classList.toggle('active', isActive);
          btn.disabled = isActive;
        }
      });
    }


    async function autoDetectPath() {
      try {
        const response = await fetch('/api/auto-detect-path');
        const result = await response.json();
        if (result.found) {
          document.getElementById('serverPath').value = result.path;
          showAlert('Server executable path auto-detected.', 'info');
        } else {
          showAlert(result.error || 'Could not auto-detect server path. Please enter manually or ensure the project is built (`npm run build`).', 'warning');
        }
      } catch (error) {
        showAlert('Auto-detection failed: ' + error.message, 'warning');
      }
    }

    function setSecurityPreset(event, presetName) {
      const preset = commandSecurityPresets[presetName];
      if (preset) {
        document.getElementById('allowedCommands').value = preset.commands.join('\n');
        updateCommandList();
        updateActiveSecurityPresets();
      }
    }

    function setUnsafePatternPreset(event, presetName) {
      const preset = unsafePatternPresets[presetName];
      if (preset) {
        document.getElementById('unsafeArgumentPatterns').value = preset.patterns.join('\n');
        updateUnsafePatternList();
        updateActiveSecurityPresets();
      }
    }

    function addToList(inputId, textareaId, updateListFunc, updatePresetsFunc) {
      const inputElement = document.getElementById(inputId);
      const itemValue = inputElement.value.trim();
      if (itemValue) {
        const textarea = document.getElementById(textareaId);
        const currentItems = textarea.value.split('\n').filter(item => item.trim());
        if (!currentItems.includes(itemValue)) {
          currentItems.push(itemValue);
          textarea.value = currentItems.join('\n');
          updateListFunc();
          if (updatePresetsFunc) updatePresetsFunc();
          inputElement.value = '';
          document.getElementById(inputId.replace('Input', 'Btn')).disabled = true;
        } else {
          showAlert(`'${itemValue}' is already in the list.`, 'warning');
        }
      }
    }

    function removeFromList(itemToRemove, textareaId, updateListFunc, updatePresetsFunc) {
      const textarea = document.getElementById(textareaId);
      const currentItems = textarea.value.split('\n').filter(item => item.trim() !== itemToRemove);
      textarea.value = currentItems.join('\n');
      updateListFunc();
      if (updatePresetsFunc) updatePresetsFunc();
    }

    function addCommand() { addToList('addCommandInput', 'allowedCommands', updateCommandList, updateActiveSecurityPresets); }
    function addSafezone() { addToList('addSafezoneInput', 'safezones', updateSafezoneList); }
    function addUnsafePattern() { addToList('addUnsafePatternInput', 'unsafeArgumentPatterns', updateUnsafePatternList, updateActiveSecurityPresets); }

    function removeCommand(command) { removeFromList(command, 'allowedCommands', updateCommandList, updateActiveSecurityPresets); }
    function removeSafezone(safezone) { removeFromList(safezone, 'safezones', updateSafezoneList); }
    function removeUnsafePattern(pattern) { removeFromList(pattern, 'unsafeArgumentPatterns', updateUnsafePatternList, updateActiveSecurityPresets); }


    function updateListDisplay(textareaId, containerId, countId, itemClass, removeFunctionPrefix) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const items = document.getElementById(textareaId).value.split('\n').filter(item => item.trim());

      items.forEach(item => {
        const tag = document.createElement('div');
        tag.className = itemClass;
        const textNode = document.createTextNode(item);
        const removeSpan = document.createElement('span');
        removeSpan.className = 'remove';
        removeSpan.innerHTML = '×';
        removeSpan.onclick = () => window[removeFunctionPrefix](item);

        tag.appendChild(textNode);
        tag.appendChild(removeSpan);
        container.appendChild(tag);
      });
      document.getElementById(countId).textContent = items.length;
    }

    function updateCommandList() { updateListDisplay('allowedCommands', 'commandList', 'commandCount', 'command-tag', 'removeCommand'); }
    function updateSafezoneList() {
      const container = document.getElementById('safezoneList');
      container.innerHTML = '';
      const items = document.getElementById('safezones').value.split('\n').filter(s => s.trim());
      items.forEach(safezone => {
        const itemEl = document.createElement('div');
        itemEl.className = 'safezone-item';
        itemEl.innerHTML = `<span class="safezone-path">${safezone}</span> <button class="btn btn-danger btn-sm" onclick="removeSafezone('${safezone}')">Remove</button>`;
        container.appendChild(itemEl);
      });
      document.getElementById('safezoneCount').textContent = items.length;
    }
    function updateUnsafePatternList() { updateListDisplay('unsafeArgumentPatterns', 'unsafePatternList', 'unsafePatternCount', 'item-tag', 'removeUnsafePattern'); }

    function updateClaudeConfigPreview() {
      document.getElementById('claudeConfigPreview').textContent = JSON.stringify(currentClaudeConfig, null, 2);
    }
    function updateServerConfigPreview() {
      // Use the global 'yaml' object which is imported in config-ui.ts
      // This assumes the HTML is served by config-ui.ts and has access to its context.
      // If this were a truly static HTML, a client-side YAML library would be needed.
      try {
        const yamlString = YAML.stringify(currentServerConfig, { indent: 2 });
        document.getElementById('serverConfigPreview').textContent = yamlString;
      } catch (e) {
        document.getElementById('serverConfigPreview').textContent = JSON.stringify(currentServerConfig, null, 2);
        showAlert('Error converting config to YAML for preview, showing JSON instead.', 'warning');
      }
    }

    function updateClaudeServerStatus() {
      const servers = currentClaudeConfig.mcpServers || {};
      const serverCount = Object.keys(servers).length;
      const serverNameInput = document.getElementById('serverName').value.trim() || 'context-savvy-mcp';
      const hasThisServer = !!servers[serverNameInput];

      let status = '🔴 Not Configured';
      if (hasThisServer) status = '🟢 Configured';
      else if (serverCount > 0) status = '🟡 Other Servers Only';
      document.getElementById('claudeServerStatus').textContent = status;
    }

    async function saveClaudeDesktopEntry() {
      const serverName = document.getElementById('serverName').value.trim();
      const serverExecutablePath = document.getElementById('serverPath').value.trim();
      const logLevel = document.getElementById('logLevel').value;

      if (!serverName || !serverExecutablePath) {
        showAlert('Please enter both Server Name and Server Executable Path for Claude Desktop.', 'danger');
        return;
      }
      try {
        showLoading('claudeConfigStatus'); // Use a more specific loading indicator if available
        const payload = { serverName, serverExecutablePath, logLevel };

        const response = await fetch('/api/claude-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.success) {
          currentClaudeConfig = result.config; // Backend now returns the full, merged config
          updateClaudeConfigPreview();
          updateClaudeServerStatus();
          showAlert('Claude Desktop configuration saved! Please restart Claude Desktop.', 'success');
        } else { throw new Error(result.error || 'Save failed'); }
      } catch (error) {
        showAlert('Failed to save Claude Desktop configuration: ' + error.message, 'danger');
      } finally {
        // Reload to reflect any status changes
        const statusEl = document.getElementById('claudeConfigStatus');
        if (statusEl.innerHTML.includes('loading')) await loadClaudeConfig();
      }
    }

    async function removeClaudeDesktopEntry() {
      const serverName = document.getElementById('serverName').value.trim();
      if (!serverName) { showAlert('Please enter the Server Name to remove from Claude Desktop.', 'danger'); return; }
      if (!confirm(`Are you sure you want to remove the server "${serverName}" from your Claude Desktop configuration?`)) return;

      try {
        showLoading('claudeConfigStatus');
        const response = await fetch('/api/claude-config/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ serverName })
        });
        const result = await response.json();

        if (result.success) {
          currentClaudeConfig = result.config; // Backend returns the updated config
          updateClaudeConfigPreview();
          updateClaudeServerStatus();
          // Optionally clear serverPath input if this was the only/main server
          // document.getElementById('serverPath').value = '';
          showAlert(`Server "${serverName}" removed from Claude Desktop configuration. Please restart Claude Desktop.`, 'success');
        } else { throw new Error(result.error || 'Remove failed'); }
      } catch (error) {
        showAlert(`Failed to remove server "${serverName}" from Claude Desktop configuration: ` + error.message, 'danger');
      } finally {
        const statusEl = document.getElementById('claudeConfigStatus');
        if (statusEl.innerHTML.includes('loading')) await loadClaudeConfig();
      }
    }


    async function saveSecurityConfig() {
      try {
        const securitySettings = {
          allowedCommands: document.getElementById('allowedCommands').value.split('\n').map(c => c.trim()).filter(c => c),
          safezones: document.getElementById('safezones').value.split('\n').map(s => s.trim()).filter(s => s),
          unsafeArgumentPatterns: document.getElementById('unsafeArgumentPatterns').value.split('\n').map(p => p.trim()).filter(p => p),
          // These are part of general server config, but often tweaked with security:
          maxExecutionTime: parseInt(document.getElementById('maxExecutionTime').value) || undefined, // Use undefined if parsing fails or 0
          maxFileSize: parseInt(document.getElementById('maxFileSize').value) || undefined
        };

        // Filter out undefined values if they were not valid numbers
        if (securitySettings.maxExecutionTime === undefined) delete securitySettings.maxExecutionTime;
        if (securitySettings.maxFileSize === undefined) delete securitySettings.maxFileSize;


        const payload = { security: securitySettings };

        const response = await fetch('/api/server-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.success) {
          showAlert('Security related settings in `server.yaml` saved successfully!', 'success');
          await loadServerConfig(); // Reload to reflect changes from server
        } else { throw new Error(result.error || 'Save failed'); }
      } catch (error) {
        showAlert('Failed to save security settings: ' + error.message, 'danger');
      }
    }

    async function saveCompleteServerConfig() {
      try {
        const configToSave = {
          server: {
            name: document.getElementById('serverName2').value || 'context-savvy-mcp',
            version: currentServerConfig.server?.version || '1.0.0' // Preserve existing if not editable here
          },
          security: { // Include all security fields from the security tab
            allowedCommands: document.getElementById('allowedCommands').value.split('\n').map(c => c.trim()).filter(c => c),
            safezones: document.getElementById('safezones').value.split('\n').map(s => s.trim()).filter(s => s),
            unsafeArgumentPatterns: document.getElementById('unsafeArgumentPatterns').value.split('\n').map(p => p.trim()).filter(p => p),
            maxExecutionTime: parseInt(document.getElementById('maxExecutionTime').value) || 30000,
            maxFileSize: parseInt(document.getElementById('maxFileSize').value) || 10485760,
            // Include other security fields from currentServerConfig if they exist and are not on UI
            autoExpandSafezones: currentServerConfig.security?.autoExpandSafezones,
            safeZoneMode: currentServerConfig.security?.safeZoneMode,
            restrictedZones: currentServerConfig.security?.restrictedZones,
            blockedPathPatterns: currentServerConfig.security?.blockedPathPatterns
          },
          database: {
            path: document.getElementById('databasePath').value || './data/context.db',
            backupInterval: parseInt(document.getElementById('backupInterval').value) || 60
          },
          logging: {
            level: document.getElementById('serverLogLevel').value || 'info',
            pretty: document.getElementById('prettyLogging').value === 'true'
          },
          performance: {
            maxConcurrency: parseInt(document.getElementById('maxConcurrency').value) || 10,
            queueSize: parseInt(document.getElementById('queueSize').value) || 1000
          }
        };

        // Clean up undefined optional fields from security
        Object.keys(configToSave.security).forEach(key => {
          if (configToSave.security[key] === undefined) {
            delete configToSave.security[key];
          }
        });


        const response = await fetch('/api/server-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(configToSave)
        });
        const result = await response.json();
        if (result.success) {
          // currentServerConfig = configToSave; // Backend is source of truth, so reload
          // updateServerConfigPreview();
          // updateActiveSecurityPresets();
          showAlert('Full `server.yaml` configuration saved successfully!', 'success');
          await loadServerConfig(); // Reload to get the exact representation from server
        } else { throw new Error(result.error || 'Save failed'); }
      } catch (error) {
        showAlert('Failed to save `server.yaml` configuration: ' + error.message, 'danger');
      }
    }

    function resetSecurityToDefaults() {
      if (confirm('Reset security settings in `server.yaml` to their defaults? This will overwrite your current settings in this tab.')) {
        setSecurityPreset(null, 'standard'); // "Standard" preset now includes tools + common OS
        setUnsafePatternPreset(null, 'balanced');
        document.getElementById('safezones').value = '.\n/tmp'; // A very basic default
        updateSafezoneList();
        // Note: maxExecutionTime and maxFileSize are on a different tab but part of security.
        // Consider if these should be reset here or handled by a full server config reset.
        // For now, this focuses on the visible fields in the Security tab.
        showAlert('Security fields reset to UI defaults. Save to apply to `server.yaml`.', 'info');
        updateActiveSecurityPresets();
      }
    }

    async function testServerConfig() {
      try {
        showLoading('serverConfigStatus'); // Indicate testing
        const response = await fetch('/api/test-config', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          let message = 'Configuration test passed!';
          if (result.warnings && result.warnings.length > 0) {
            message += '\n\nWarnings:\n' + result.warnings.join('\n');
            showAlert(message, 'warning', 10000); // Longer for warnings
          } else {
            showAlert(message, 'success');
          }
        } else {
          let errMessage = 'Configuration test failed.';
          if (result.errors && result.errors.length > 0) errMessage += '\n\nErrors:\n' + result.errors.join('\n');
          if (result.warnings && result.warnings.length > 0) errMessage += '\n\nWarnings:\n' + result.warnings.join('\n');
          showAlert(errMessage, 'danger', 15000); // Longer for errors
        }
      } catch (error) {
        showAlert('Failed to test configuration: ' + error.message, 'danger');
      } finally {
        const statusEl = document.getElementById('serverConfigStatus');
        if (statusEl.innerHTML.includes('loading')) await loadServerConfig(); // Reload to clear loading
      }
    }

    function showAlert(message, type = 'info', duration = 5000) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const messageSpan = document.createElement('span');
      messageSpan.className = 'toast-message';
      messageSpan.textContent = message;

      const closeButton = document.createElement('button');
      closeButton.className = 'toast-close-btn';
      closeButton.innerHTML = '×';
      closeButton.onclick = () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
      };

      toast.appendChild(messageSpan);
      toast.appendChild(closeButton);
      toastContainer.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 100); // Delay to allow CSS transition

      // Auto-dismiss for non-danger toasts
      if (duration > 0 && type !== 'danger') {
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 500); // Remove from DOM after transition
        }, duration);
      }
    }


    function showLoading(elementId) {
      const el = document.getElementById(elementId);
      if (el) {
        el.innerHTML = '<span class="loading"></span> Loading...';
      }
    }

    // Update lists and presets on textarea input
    ['allowedCommands', 'safezones', 'unsafeArgumentPatterns'].forEach(textareaId => {
      const el = document.getElementById(textareaId);
      if (el) {
        el.addEventListener('input', () => {
          if (textareaId === 'allowedCommands') updateCommandList();
          else if (textareaId === 'safezones') updateSafezoneList();
          else if (textareaId === 'unsafeArgumentPatterns') updateUnsafePatternList();

          // Only update security presets if allowedCommands or unsafeArgumentPatterns changed
          if (textareaId === 'allowedCommands' || textareaId === 'unsafeArgumentPatterns') {
            updateActiveSecurityPresets();
          }
        });
      }
    });

  </script>
</body>

</html>