<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Context Server - Configuration Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border: #475569;
      --radius: 8px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2rem;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .tabs {
      display: flex;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 0.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .tab {
      flex: 1;
      padding: 1rem 1.5rem;
      text-align: center;
      cursor: pointer;
      border-radius: calc(var(--radius) - 2px);
      transition: all 0.2s;
      font-weight: 500;
      color: var(--text-muted);
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .tab:hover:not(.active) {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .main-section {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-icon {
      width: 1.5rem;
      height: 1.5rem;
      background: var(--primary);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    .config-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .status-card {
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .status-card h3 {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .status-card .value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-control:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .config-preview {
      background: #000;
      color: #00ff00;
      padding: 1rem;
      border-radius: var(--radius);
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 1rem;
      border: 1px solid var(--border);
    }

    .command-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .command-tag {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid var(--border);
    }

    .command-tag .remove {
      cursor: pointer;
      color: var(--danger);
      font-weight: bold;
      padding: 0 0.25rem;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.1);
    }

    .command-tag .remove:hover {
      background: var(--danger);
      color: white;
    }

    .safezone-list {
      margin-top: 1rem;
    }

    .safezone-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
    }

    .safezone-path {
      font-family: monospace;
      color: var(--text-primary);
    }

    .alert {
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1rem;
      border-left: 4px solid;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border-left-color: var(--success);
      color: var(--success);
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border-left-color: var(--warning);
      color: var(--warning);
    }

    .alert-danger {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: var(--danger);
      color: var(--danger);
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border-left-color: var(--primary);
      color: var(--primary);
    }

    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .path-display {
      background: var(--bg-tertiary);
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      word-break: break-all;
    }

    .server-config {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .security-presets {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .preset-btn {
      padding: 0.75rem;
      text-align: center;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid var(--border);
      background: var(--bg-tertiary);
    }

    .preset-btn:hover {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
    }

    .preset-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .preset-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .preset-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    @media (max-width: 768px) {

      .server-config,
      .grid-2 {
        grid-template-columns: 1fr;
      }

      .config-status {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        margin-bottom: 0.25rem;
      }
    }

    .instructions {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-top: 2rem;
    }

    .instructions h3 {
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .instructions ol {
      padding-left: 1.5rem;
    }

    .instructions li {
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>MCP Context Server</h1>
      <p>Complete Configuration Management for Claude Desktop Integration & Server Security</p>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('claude-desktop')">🔗 Claude Desktop</div>
      <div class="tab" onclick="switchTab('security')">🔒 Security Settings</div>
      <div class="tab" onclick="switchTab('server')">⚙️ Server Configuration</div>
    </div>

    <!-- Claude Desktop Configuration Tab -->
    <div class="tab-content active" id="claude-desktop-tab">
      <div class="main-section">
        <h2 class="section-title">
          <span class="section-icon">🔗</span>
          Claude Desktop Integration
        </h2>

        <div class="config-status">
          <div class="status-card">
            <h3>Config File Status</h3>
            <div class="value" id="claudeConfigStatus">Checking...</div>
          </div>
          <div class="status-card">
            <h3>Platform</h3>
            <div class="value" id="platformInfo">-</div>
          </div>
          <div class="status-card">
            <h3>MCP Server Status</h3>
            <div class="value" id="claudeServerStatus">Not Configured</div>
          </div>
        </div>

        <div class="form-group">
          <label for="claudeConfigPath">Claude Desktop Config File Location</label>
          <div class="path-display" id="claudeConfigPath">Detecting...</div>
        </div>

        <div class="server-config">
          <div>
            <div class="form-group">
              <label for="serverName">Server Name</label>
              <input type="text" id="serverName" class="form-control" value="context-server"
                placeholder="context-server">
              <div class="help-text">Unique name for your MCP server in Claude Desktop</div>
            </div>

            <div class="form-group">
              <label for="serverPath">Server Path</label>
              <input type="text" id="serverPath" class="form-control" placeholder="/absolute/path/to/dist/index.js">
              <div class="help-text">Absolute path to your built server (index.js)</div>
            </div>

            <div class="form-group">
              <label for="logLevel">Log Level</label>
              <select id="logLevel" class="form-control">
                <option value="error">Error</option>
                <option value="warn">Warning</option>
                <option value="info" selected>Info</option>
                <option value="debug">Debug</option>
              </select>
            </div>
          </div>

          <div>
            <div class="form-group">
              <label>Quick Actions</label>
              <div class="btn-group">
                <button class="btn btn-primary" onclick="autoDetectPath()">🔍 Auto-Detect Path</button>
                <button class="btn btn-secondary" onclick="loadClaudeConfig()">🔄 Load Current</button>
              </div>
            </div>

            <div class="form-group">
              <label>Configuration Actions</label>
              <div class="btn-group">
                <button class="btn btn-success" onclick="saveClaudeConfiguration()">💾 Save Config</button>
                <button class="btn btn-warning" onclick="removeServer()">🗑️ Remove Server</button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="claudeConfigPreview">Current Configuration Preview</label>
          <div class="config-preview" id="claudeConfigPreview">Loading configuration...</div>
        </div>
      </div>
    </div>

    <!-- Security Settings Tab -->
    <div class="tab-content" id="security-tab">
      <div class="main-section">
        <h2 class="section-title">
          <span class="section-icon">🔒</span>
          Security Configuration
        </h2>

        <div class="config-status">
          <div class="status-card">
            <h3>Server Config Status</h3>
            <div class="value" id="serverConfigStatus">Checking...</div>
          </div>
          <div class="status-card">
            <h3>Allowed Commands</h3>
            <div class="value" id="commandCount">-</div>
          </div>
          <div class="status-card">
            <h3>Safe Zones</h3>
            <div class="value" id="safezoneCount">-</div>
          </div>
        </div>

        <div class="form-group">
          <label>Security Presets</label>
          <div class="help-text">Choose a security level that matches your needs</div>
          <div class="security-presets">
            <div class="preset-btn" onclick="setSecurityPreset('minimal')">
              <div class="preset-title">🛡️ Minimal</div>
              <div class="preset-desc">Basic commands only</div>
            </div>
            <div class="preset-btn" onclick="setSecurityPreset('standard')">
              <div class="preset-title">⚖️ Standard</div>
              <div class="preset-desc">Common dev commands</div>
            </div>
            <div class="preset-btn" onclick="setSecurityPreset('developer')">
              <div class="preset-title">🔧 Developer</div>
              <div class="preset-desc">Full dev toolkit</div>
            </div>
            <div class="preset-btn" onclick="setSecurityPreset('custom')">
              <div class="preset-title">⚙️ Custom</div>
              <div class="preset-desc">Configure manually</div>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <div class="form-group">
              <label for="allowedCommands">Allowed Commands</label>
              <div class="help-text">Commands that the server can execute (one per line)</div>
              <textarea id="allowedCommands" class="form-control" rows="8"
                placeholder="ls&#10;cat&#10;grep&#10;find&#10;echo"></textarea>
            </div>

            <div class="form-group">
              <label for="addCommand">Add Command</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="addCommand" class="form-control" placeholder="e.g., python3">
                <button class="btn btn-primary" onclick="addCommand()">Add</button>
              </div>
            </div>

            <div class="command-list" id="commandList"></div>
          </div>

          <div>
            <div class="form-group">
              <label for="safezones">Safe Zones</label>
              <div class="help-text">Directories where file operations are allowed (one per line)</div>
              <textarea id="safezones" class="form-control" rows="6"
                placeholder=".&#10;/tmp&#10;/home/user/projects"></textarea>
            </div>

            <div class="form-group">
              <label for="addSafezone">Add Safe Zone</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="addSafezone" class="form-control" placeholder="/path/to/directory">
                <button class="btn btn-primary" onclick="addSafezone()">Add</button>
              </div>
            </div>

            <div class="safezone-list" id="safezoneList"></div>
          </div>
        </div>

        <div class="btn-group" style="margin-top: 2rem;">
          <button class="btn btn-success" onclick="saveSecurityConfig()">💾 Save Security Settings</button>
          <button class="btn btn-secondary" onclick="loadSecurityConfig()">🔄 Reload Settings</button>
          <button class="btn btn-warning" onclick="resetToDefaults()">↩️ Reset to Defaults</button>
        </div>
      </div>
    </div>

    <!-- Server Configuration Tab -->
    <div class="tab-content" id="server-tab">
      <div class="main-section">
        <h2 class="section-title">
          <span class="section-icon">⚙️</span>
          Server Configuration
        </h2>

        <div class="grid-2">
          <div>
            <div class="form-group">
              <label for="serverName2">Server Name</label>
              <input type="text" id="serverName2" class="form-control" value="mcp-context-server">
            </div>

            <div class="form-group">
              <label for="maxExecutionTime">Max Execution Time (ms)</label>
              <input type="number" id="maxExecutionTime" class="form-control" value="30000">
              <div class="help-text">Maximum time for command execution</div>
            </div>

            <div class="form-group">
              <label for="maxFileSize">Max File Size (bytes)</label>
              <input type="number" id="maxFileSize" class="form-control" value="10485760">
              <div class="help-text">Maximum file size for operations (10MB default)</div>
            </div>

            <div class="form-group">
              <label for="maxConcurrency">Max Concurrency</label>
              <input type="number" id="maxConcurrency" class="form-control" value="10">
              <div class="help-text">Maximum concurrent operations</div>
            </div>
          </div>

          <div>
            <div class="form-group">
              <label for="databasePath">Database Path</label>
              <input type="text" id="databasePath" class="form-control" value="./data/context.db">
              <div class="help-text">Path to SQLite database file</div>
            </div>

            <div class="form-group">
              <label for="backupInterval">Backup Interval (minutes)</label>
              <input type="number" id="backupInterval" class="form-control" value="60">
              <div class="help-text">0 to disable automatic backups</div>
            </div>

            <div class="form-group">
              <label for="serverLogLevel">Server Log Level</label>
              <select id="serverLogLevel" class="form-control">
                <option value="trace">Trace</option>
                <option value="debug">Debug</option>
                <option value="info" selected>Info</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
                <option value="fatal">Fatal</option>
              </select>
            </div>

            <div class="form-group">
              <label for="prettyLogging">Pretty Logging</label>
              <select id="prettyLogging" class="form-control">
                <option value="true" selected>Enabled</option>
                <option value="false">Disabled</option>
              </select>
            </div>
          </div>
        </div>

        <div class="btn-group" style="margin-top: 2rem;">
          <button class="btn btn-success" onclick="saveServerConfig()">💾 Save Server Config</button>
          <button class="btn btn-secondary" onclick="loadServerConfig()">🔄 Reload Config</button>
          <button class="btn btn-primary" onclick="testServerConfig()">🧪 Test Configuration</button>
        </div>

        <div class="form-group" style="margin-top: 2rem;">
          <label for="serverConfigPreview">Server Configuration Preview</label>
          <div class="config-preview" id="serverConfigPreview">Loading server configuration...</div>
        </div>
      </div>
    </div>

    <div class="instructions">
      <h3>🚀 Complete Setup Guide</h3>
      <ol>
        <li><strong>Configure Security:</strong> Set allowed commands and safe zones for your use case</li>
        <li><strong>Adjust Server Settings:</strong> Configure timeouts, file sizes, and logging preferences</li>
        <li><strong>Setup Claude Desktop:</strong> Configure the integration path and settings</li>
        <li><strong>Save All Changes:</strong> Apply configurations to both server and Claude Desktop</li>
        <li><strong>Restart Claude Desktop:</strong> Close and reopen Claude Desktop completely</li>
        <li><strong>Test Integration:</strong> Ask Claude to list files or execute commands</li>
      </ol>

      <div class="alert alert-info" style="margin-top: 1rem;">
        <strong>💡 Pro Tip:</strong> Start with "Standard" security preset and adjust as needed. You can always modify
        settings later through this interface.
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentClaudeConfig = {};
    let currentServerConfig = {};
    let claudeConfigPath = '';
    let platformInfo = {};

    // Security presets
    const securityPresets = {
      minimal: {
        commands: ['echo', 'pwd'],
        description: 'Basic commands only - safest option'
      },
      standard: {
        commands: ['ls', 'cat', 'grep', 'find', 'echo', 'pwd', 'whoami'],
        description: 'Common development commands'
      },
      developer: {
        commands: ['ls', 'cat', 'grep', 'find', 'echo', 'pwd', 'whoami', 'node', 'npm', 'git', 'python', 'python3'],
        description: 'Full development toolkit'
      },
      custom: {
        commands: [],
        description: 'Configure manually'
      }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await detectPlatform();
      await loadClaudeConfig();
      await loadSecurityConfig();
      await loadServerConfig();
      await autoDetectPath();
    });

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    async function detectPlatform() {
      try {
        const response = await fetch('/api/platform-info');
        platformInfo = await response.json();

        document.getElementById('platformInfo').textContent = platformInfo.platformName;
        claudeConfigPath = platformInfo.configPath;
        document.getElementById('claudeConfigPath').textContent = claudeConfigPath;

        showAlert('Platform detected: ' + platformInfo.platformName, 'info');
      } catch (error) {
        showAlert('Failed to detect platform: ' + error.message, 'danger');
      }
    }

    async function loadClaudeConfig() {
      try {
        showLoading('claudeConfigStatus');

        const response = await fetch('/api/claude-config');
        const result = await response.json();

        if (result.exists) {
          currentClaudeConfig = result.config;
          updateClaudeConfigPreview();
          updateClaudeServerStatus();

          // Load server settings if they exist
          const servers = currentClaudeConfig.mcpServers || {};
          const contextServer = Object.values(servers).find(server =>
            server.args && server.args.some(arg => arg.includes('context-server') || arg.includes('index.js'))
          );

          if (contextServer) {
            const serverName = Object.keys(servers).find(name => servers[name] === contextServer);
            document.getElementById('serverName').value = serverName || 'context-server';
            document.getElementById('serverPath').value = contextServer.args[contextServer.args.length - 1] || '';
            document.getElementById('logLevel').value = contextServer.env?.MCP_LOG_LEVEL || 'info';
          }

          document.getElementById('claudeConfigStatus').textContent = '✅ Found';
        } else {
          document.getElementById('claudeConfigStatus').textContent = '📄 Not Found';
          currentClaudeConfig = { mcpServers: {} };
          updateClaudeConfigPreview();
        }
      } catch (error) {
        document.getElementById('claudeConfigStatus').textContent = '❌ Error';
        showAlert('Failed to load Claude Desktop configuration: ' + error.message, 'danger');
      }
    }

    async function loadSecurityConfig() {
      try {
        showLoading('serverConfigStatus');

        const response = await fetch('/api/server-config');
        const result = await response.json();

        if (result.exists) {
          currentServerConfig = result.config;

          // Update security settings
          const commands = result.config.security?.allowedCommands || [];
          const safezones = result.config.security?.safezones || [];

          document.getElementById('allowedCommands').value = Array.isArray(commands) ? commands.join('\n') : '';
          document.getElementById('safezones').value = safezones.join('\n');

          updateCommandList(commands);
          updateSafezoneList(safezones);
          updateCommandCount();
          updateSafezoneCount();

          document.getElementById('serverConfigStatus').textContent = '✅ Found';
        } else {
          document.getElementById('serverConfigStatus').textContent = '📄 Not Found';
          // Set defaults
          setSecurityPreset('standard');
        }
      } catch (error) {
        document.getElementById('serverConfigStatus').textContent = '❌ Error';
        showAlert('Failed to load server configuration: ' + error.message, 'danger');
      }
    }

    async function loadServerConfig() {
      try {
        const response = await fetch('/api/server-config');
        const result = await response.json();

        if (result.exists) {
          const config = result.config;

          // Update server settings
          document.getElementById('serverName2').value = config.server?.name || 'mcp-context-server';
          document.getElementById('maxExecutionTime').value = config.security?.maxExecutionTime || 30000;
          document.getElementById('maxFileSize').value = config.security?.maxFileSize || 10485760;
          document.getElementById('maxConcurrency').value = config.performance?.maxConcurrency || 10;
          document.getElementById('databasePath').value = config.database?.path || './data/context.db';
          document.getElementById('backupInterval').value = config.database?.backupInterval || 60;
          document.getElementById('serverLogLevel').value = config.logging?.level || 'info';
          document.getElementById('prettyLogging').value = String(config.logging?.pretty !== false);

          updateServerConfigPreview();
        }
      } catch (error) {
        showAlert('Failed to load server configuration: ' + error.message, 'danger');
      }
    }

    async function autoDetectPath() {
      try {
        const response = await fetch('/api/auto-detect-path');
        const result = await response.json();

        if (result.found) {
          document.getElementById('serverPath').value = result.path;
          showAlert('Server path auto-detected: ' + result.path, 'success');
        } else {
          showAlert('Could not auto-detect server path. Please enter manually.', 'warning');
        }
      } catch (error) {
        showAlert('Auto-detection failed: ' + error.message, 'warning');
      }
    }

    function setSecurityPreset(presetName) {
      // Update active preset button
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      const preset = securityPresets[presetName];
      if (preset) {
        document.getElementById('allowedCommands').value = preset.commands.join('\n');
        updateCommandList(preset.commands);
        updateCommandCount();

        if (presetName !== 'custom') {
          showAlert(`Security preset applied: ${presetName}`, 'success');
        }
      }
    }

    function addCommand() {
      const input = document.getElementById('addCommand');
      const command = input.value.trim();
      if (command) {
        const currentCommands = document.getElementById('allowedCommands').value.split('\n').filter(c => c.trim());
        if (!currentCommands.includes(command)) {
          currentCommands.push(command);
          document.getElementById('allowedCommands').value = currentCommands.join('\n');
          updateCommandList(currentCommands);
          updateCommandCount();
          input.value = '';
        }
      }
    }

    function addSafezone() {
      const input = document.getElementById('addSafezone');
      const safezone = input.value.trim();
      if (safezone) {
        const currentSafezones = document.getElementById('safezones').value.split('\n').filter(s => s.trim());
        if (!currentSafezones.includes(safezone)) {
          currentSafezones.push(safezone);
          document.getElementById('safezones').value = currentSafezones.join('\n');
          updateSafezoneList(currentSafezones);
          updateSafezoneCount();
          input.value = '';
        }
      }
    }

    function removeCommand(command) {
      const commands = document.getElementById('allowedCommands').value.split('\n').filter(c => c.trim() !== command);
      document.getElementById('allowedCommands').value = commands.join('\n');
      updateCommandList(commands);
      updateCommandCount();
    }

    function removeSafezone(safezone) {
      const safezones = document.getElementById('safezones').value.split('\n').filter(s => s.trim() !== safezone);
      document.getElementById('safezones').value = safezones.join('\n');
      updateSafezoneList(safezones);
      updateSafezoneCount();
    }

    function updateCommandList(commands) {
      const container = document.getElementById('commandList');
      container.innerHTML = '';

      commands.forEach(command => {
        if (command.trim()) {
          const tag = document.createElement('div');
          tag.className = 'command-tag';
          tag.innerHTML = `${command} <span class="remove" onclick="removeCommand('${command}')">&times;</span>`;
          container.appendChild(tag);
        }
      });
    }

    function updateSafezoneList(safezones) {
      const container = document.getElementById('safezoneList');
      container.innerHTML = '';

      safezones.forEach(safezone => {
        if (safezone.trim()) {
          const item = document.createElement('div');
          item.className = 'safezone-item';
          item.innerHTML = `
            <span class="safezone-path">${safezone}</span>
            <button class="btn btn-danger btn-sm" onclick="removeSafezone('${safezone}')">Remove</button>
          `;
          container.appendChild(item);
        }
      });
    }

    function updateCommandCount() {
      const commands = document.getElementById('allowedCommands').value.split('\n').filter(c => c.trim());
      document.getElementById('commandCount').textContent = commands.length;
    }

    function updateSafezoneCount() {
      const safezones = document.getElementById('safezones').value.split('\n').filter(s => s.trim());
      document.getElementById('safezoneCount').textContent = safezones.length;
    }

    function updateClaudeConfigPreview() {
      const preview = document.getElementById('claudeConfigPreview');
      preview.textContent = JSON.stringify(currentClaudeConfig, null, 2);
    }

    function updateServerConfigPreview() {
      const preview = document.getElementById('serverConfigPreview');
      preview.textContent = JSON.stringify(currentServerConfig, null, 2);
    }

    function updateClaudeServerStatus() {
      const servers = currentClaudeConfig.mcpServers || {};
      const serverCount = Object.keys(servers).length;
      const hasContextServer = Object.values(servers).some(server =>
        server.args && server.args.some(arg => arg.includes('context-server') || arg.includes('index.js'))
      );

      let status = '🔴 Not Configured';
      if (hasContextServer) {
        status = '🟢 Configured';
      } else if (serverCount > 0) {
        status = '🟡 Other Servers';
      }

      document.getElementById('claudeServerStatus').textContent = status;
    }

    async function saveClaudeConfiguration() {
      const serverName = document.getElementById('serverName').value.trim();
      const serverPath = document.getElementById('serverPath').value.trim();
      const logLevel = document.getElementById('logLevel').value;

      if (!serverName || !serverPath) {
        showAlert('Please enter both server name and path', 'danger');
        return;
      }

      try {
        showLoading('claudeConfigStatus');

        const newConfig = {
          ...currentClaudeConfig,
          mcpServers: {
            ...currentClaudeConfig.mcpServers,
            [serverName]: {
              command: 'node',
              args: [serverPath],
              env: {
                MCP_LOG_LEVEL: logLevel
              }
            }
          }
        };

        const response = await fetch('/api/claude-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newConfig)
        });

        const result = await response.json();

        if (result.success) {
          currentClaudeConfig = newConfig;
          updateClaudeConfigPreview();
          updateClaudeServerStatus();
          document.getElementById('claudeConfigStatus').textContent = '✅ Saved';
          showAlert('Claude Desktop configuration saved! Please restart Claude Desktop.', 'success');
        } else {
          throw new Error(result.error || 'Save failed');
        }
      } catch (error) {
        document.getElementById('claudeConfigStatus').textContent = '❌ Error';
        showAlert('Failed to save Claude Desktop configuration: ' + error.message, 'danger');
      }
    }

    async function saveSecurityConfig() {
      try {
        const commands = document.getElementById('allowedCommands').value.split('\n').filter(c => c.trim());
        const safezones = document.getElementById('safezones').value.split('\n').filter(s => s.trim());

        const securityConfig = {
          security: {
            allowedCommands: commands,
            safezones: safezones,
            maxExecutionTime: parseInt(document.getElementById('maxExecutionTime').value) || 30000,
            maxFileSize: parseInt(document.getElementById('maxFileSize').value) || 10485760
          }
        };

        const response = await fetch('/api/server-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(securityConfig)
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Security configuration saved successfully!', 'success');
          updateCommandList(commands);
          updateSafezoneList(safezones);
        } else {
          throw new Error(result.error || 'Save failed');
        }
      } catch (error) {
        showAlert('Failed to save security configuration: ' + error.message, 'danger');
      }
    }

    async function saveServerConfig() {
      try {
        const serverConfig = {
          server: {
            name: document.getElementById('serverName2').value || 'mcp-context-server',
            version: '1.0.0'
          },
          security: {
            allowedCommands: document.getElementById('allowedCommands').value.split('\n').filter(c => c.trim()),
            safezones: document.getElementById('safezones').value.split('\n').filter(s => s.trim()),
            maxExecutionTime: parseInt(document.getElementById('maxExecutionTime').value) || 30000,
            maxFileSize: parseInt(document.getElementById('maxFileSize').value) || 10485760
          },
          database: {
            path: document.getElementById('databasePath').value || './data/context.db',
            backupInterval: parseInt(document.getElementById('backupInterval').value) || 60
          },
          logging: {
            level: document.getElementById('serverLogLevel').value || 'info',
            pretty: document.getElementById('prettyLogging').value === 'true'
          },
          performance: {
            maxConcurrency: parseInt(document.getElementById('maxConcurrency').value) || 10,
            queueSize: 1000
          }
        };

        const response = await fetch('/api/server-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(serverConfig)
        });

        const result = await response.json();

        if (result.success) {
          currentServerConfig = serverConfig;
          updateServerConfigPreview();
          showAlert('Server configuration saved successfully!', 'success');
        } else {
          throw new Error(result.error || 'Save failed');
        }
      } catch (error) {
        showAlert('Failed to save server configuration: ' + error.message, 'danger');
      }
    }

    async function removeServer() {
      const serverName = document.getElementById('serverName').value.trim();

      if (!serverName) {
        showAlert('Please enter the server name to remove', 'danger');
        return;
      }

      if (!confirm('Are you sure you want to remove the server "' + serverName + '"?')) {
        return;
      }

      try {
        const newConfig = { ...currentClaudeConfig };
        if (newConfig.mcpServers && newConfig.mcpServers[serverName]) {
          delete newConfig.mcpServers[serverName];
        }

        const response = await fetch('/api/claude-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newConfig)
        });

        const result = await response.json();

        if (result.success) {
          currentClaudeConfig = newConfig;
          updateClaudeConfigPreview();
          updateClaudeServerStatus();

          document.getElementById('serverPath').value = '';

          showAlert('Server removed successfully! Please restart Claude Desktop.', 'success');
        } else {
          throw new Error(result.error || 'Remove failed');
        }
      } catch (error) {
        showAlert('Failed to remove server: ' + error.message, 'danger');
      }
    }

    function resetToDefaults() {
      if (confirm('Reset all security settings to defaults? This will overwrite your current configuration.')) {
        setSecurityPreset('standard');
        document.getElementById('safezones').value = '.\n/tmp';
        updateSafezoneList(['.', '/tmp']);
        updateSafezoneCount();
        showAlert('Security settings reset to defaults', 'info');
      }
    }

    async function testServerConfig() {
      try {
        const response = await fetch('/api/test-config', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
          showAlert('Configuration test passed!', 'success');
        } else {
          showAlert('Configuration test failed: ' + result.error, 'warning');
        }
      } catch (error) {
        showAlert('Failed to test configuration: ' + error.message, 'danger');
      }
    }

    function showAlert(message, type) {
      // Remove existing alerts
      const existingAlerts = document.querySelectorAll('.alert');
      existingAlerts.forEach(alert => {
        if (!alert.classList.contains('alert-info') || !alert.textContent.includes('Pro Tip:')) {
          alert.remove();
        }
      });

      // Create new alert
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;

      // Insert at the top of the page
      const container = document.querySelector('.container');
      container.insertBefore(alert, container.children[1]);

      // Auto-remove after 5 seconds for non-error messages
      if (type !== 'danger') {
        setTimeout(() => {
          alert.remove();
        }, 5000);
      }
    }

    function showLoading(elementId) {
      const element = document.getElementById(elementId);
      element.innerHTML = '<span class="loading"></span> Loading...';
    }

    // Auto-update command and safezone lists when text areas change
    document.getElementById('allowedCommands').addEventListener('input', () => {
      const commands = document.getElementById('allowedCommands').value.split('\n').filter(c => c.trim());
      updateCommandList(commands);
      updateCommandCount();
    });

    document.getElementById('safezones').addEventListener('input', () => {
      const safezones = document.getElementById('safezones').value.split('\n').filter(s => s.trim());
      updateSafezoneList(safezones);
      updateSafezoneCount();
    });
  </script>
</body>

</html>